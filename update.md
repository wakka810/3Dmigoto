作業書：D3D11プロキシDLLの On12・互換性・安定性対応アップデート

======================================================================

1. # 目的
   現行の D3D11 プロキシ DLL（d3d11.dll ラッパー/フック）を更新し、
   以下の問題を解消/低減する：

- On12対応：D3D11On12CreateDevice エクスポート欠落によるロード失敗回避
- 互換性：DXGI2系SwapChain経路、上位D3D11 IF、プロキシチェイン共存
- 安定性：LoadLibrary再帰/無限ループ、誤爆（対象外exeで動作）防止
- DPI：高DPI環境でのオーバーレイ/入力座標ズレ低減（動的ロード＋フォールバック）

====================================================================== 2. 成果物（Deliverables）
======================================================================
A. ソースコード変更

====================================================================== 3. 非機能要件（品質・互換）
======================================================================

- Real d3d11.dll への転送失敗でもクラッシュしない（明確な失敗返却＋ログ）
- OS世代差があるAPIは静的リンク禁止（LoadLibrary/GetProcAddressで動的解決）
- LoadLibraryフック/プロキシチェイン時に無限再帰を起こさない（再入防止）
- 初期化・フォールバック・パススルーの判定理由を最低限ログに残す

====================================================================== 4. スコープ（優先度）
======================================================================
[必須 P0]
P0-1: D3D11On12CreateDevice の export 追加＋Realへフォワード
P0-2: DPI互換（GetDpiForMonitor / SetThreadDpiAwarenessContext）動的ロード＋復元
P0-3: load_library_redirect 相当のリダイレクト制御（無限再帰/プロキシ共存対策）
P0-4: ターゲットexe判定（設定ベース）→ 対象外は完全パススルー

[推奨 P1]
P1-1: DXGI2（IDXGIFactory2）SwapChain経路（ForHwnd/CoreWindow/Composition）網羅
P1-2: ID3D11Device 上位IF（Device1..5 等）QueryInterface取りこぼし抑止（ラッパー整備）

====================================================================== 5. 実装方針（元ソースへの落とし込み）
======================================================================

---

## 5.1 On12対応（D3D11On12CreateDevice）

目的：エクスポート欠落による依存DLLロード失敗を回避する。
方針：On12の中身を実装しない。Real d3d11.dll の同名関数へフォワードする。

タスク：
[ ] typedef PFN_D3D11On12CreateDevice を追加（d3d11on12.h準拠のシグネチャ）
[ ] Real d3d11.dll ロード完了後に GetProcAddress("D3D11On12CreateDevice") を解決し保持
[ ] export 関数 D3D11On12CreateDevice を追加し、保持した関数へ転送
[ ] 未解決（Realが未提供）なら E_NOTIMPL 等で失敗返却＋警告ログ

受入条件：
[ ] On12 import を要求する環境で entry point not found が出ない
[ ] Realが未提供でもクラッシュせず失敗返却する

実装メモ（スケッチ）：

- EnsureRealD3D11Loaded() 内で g_pD3D11On12CreateDevice を遅延解決
- export 側は EnsureRealD3D11Loaded() → NULLチェック → forward

---

## 5.2 DPI互換（高DPI/スケーリング）

目的：高DPI環境でのオーバーレイ/入力ズレを低減し、OS差で落ちないようにする。

タスク：
[ ] LoadLibraryA("Shcore.dll") → GetProcAddress("GetDpiForMonitor")
[ ] LoadLibraryA("user32.dll") → GetProcAddress("SetThreadDpiAwarenessContext")
[ ] DPI取得時は（必要なら）SetThreadDpiAwarenessContextで一時的に切替 → 取得 → 必ず復元
[ ] 関数が取得できない場合は DPI=96 フォールバック＋警告ログ

受入条件：
[ ] API未提供環境でもロード時クラッシュしない（動的解決のため）
[ ] 高DPI環境で致命的な座標/入力ズレが出ない（最小限）

---

## 5.3 load_library_redirect / 無限再帰・プロキシ共存対策

目的：プロキシチェインやLoadLibraryフック環境での再帰・破綻を防ぐ。

タスク：
[ ] 設定（ini等）に load*library_redirect を追加（既存なら仕様整理）
[ ] “プロキシチェイン検出時” は redirect を強制OFF（ログ付き）
[ ] LoadLibraryフックがある場合は TLS/スレッドローカル再入ガード導入（in_loader等）
[ ] 抑止トークン（例：SUPPRESS*\*）を見たら、そのスコープで redirect を無効化（1回限り）

受入条件：
[ ] proxy loading（別プロキシ同居）で起動できる
[ ] 無限再帰/スタックオーバーフローが起きない
[ ] redirect ON/OFF の理由がログで追える

---

## 5.4 ターゲットexe判定（誤爆防止）

目的：想定外プロセスでフックが動く事故を防ぎ、共存性を上げる。

タスク：
[ ] GetModuleFileNameW(NULL,...) で実行ファイル名取得
[ ] 設定 [Loader] Target=... 等と照合
[ ] 不一致時は初期化を縮退（フック導入しない/主要APIはrealへ直転送）
[ ] ログ：不一致理由を1行で出す（機密情報は出しすぎない）

受入条件：
[ ] 対象外exeでは副作用（フック/オーバーレイ）が発生しない
[ ] 対象exeでは従来通り動作する

---

## 5.5 DXGI2 SwapChain系（推奨）

目的：現代アプリで使われやすいSwapChain作成経路の取りこぼしを防ぐ。

タスク：
[ ] CreateDXGIFactory1/2 → IDXGIFactory2 取得（QI）
[ ] CreateSwapChain / CreateSwapChainForHwnd / ForCoreWindow / ForComposition を網羅
[ ] フック導入点を共通化（vtable差替 or ラッパ）

受入条件：
[ ] DXGI2経路でも対象exe時にフックが機能する
[ ] 対象外exeではパススルー維持

---

## 5.6 ID3D11Device 上位IF（推奨）

目的：QueryInterfaceで上位IFが要求された際にrealが漏れてラッパ整合が崩れる事故を防ぐ。

タスク：
[ ] Wrapperで QueryInterface を実装し、既知IIDは対応ラッパIFを返す
[ ] 未対応IIDはrealへ委譲（ログで検出可能に）
[ ] unwrap/rewrap 機構があるなら対応表を更新

受入条件：
[ ] 上位IF要求時に “Unwrapped” 相当の異常が出ない/抑止できる

====================================================================== 6. ビルド/依存更新
======================================================================
[ ] Windows SDK 更新（Win10 SDK相当）で On12/DPI API の宣言・ビルド条件を整理
[ ] ただし呼び出し自体は動的解決を徹底（旧OSで落とさない）

====================================================================== 7. Definition of Done（受入基準）
======================================================================
[ ] D3D11On12CreateDevice がエクスポートされ、依存DLLロード失敗が再現しない
[ ] On12未対応環境でもクラッシュせず明確な失敗返却/ログで終わる
[ ] DPI API未提供環境でも落ちない（動的解決＋フォールバック）
[ ] proxy loading/フック導入で無限再帰が起きない
[ ] 対象外exeでは機能抑止され副作用が発生しない
[ ] テストログとリリースノートが揃っている

====================================================================== 8. 初動（エージェントが最初にやること）
======================================================================
[ ] 現行元ソースで以下の実装箇所を特定：1) d3d11.dll のロード・関数解決モジュール2) Export 定義（.def/リンカ/ビルド設定）3) DPI/Window/UI座標計算モジュール4) LoadLibraryフック/redirect設定モジュール5) DXGIフック（factory/swapchain）モジュール
